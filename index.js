const { Telegraf, Markup } = require('telegraf')
const { config } = require('dotenv')
const { GoogleGenerativeAI } = require('@google/generative-ai')
const cron = require('node-cron')

// Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ñ… Ð¾ÐºÑ€ÑƒÐ¶ÐµÐ½Ð¸Ñ
config()

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð±Ð¾Ñ‚Ð°
const bot = new Telegraf(process.env.BOT_TOKEN)

// Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Gemini API
const genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY)

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ñ‡Ð°Ñ‚-ÑÐµÑÑÐ¸Ð¹
const chatSessions = new Map()

// Ð¥Ñ€Ð°Ð½Ð¸Ð»Ð¸Ñ‰Ðµ Ð¿Ð¾Ð´Ð¿Ð¸ÑÑ‡Ð¸ÐºÐ¾Ð² Ð½Ð° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
const subscribers = new Set()

// Ð£Ñ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ Ð¸ Ð²ÐµÑ‡ÐµÑ€Ð½Ð¸Ðµ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚Ð¸
const morningWisdoms = [
  'ÐšÐ°Ð¶Ð´Ð¾Ðµ ÑƒÑ‚Ñ€Ð¾ - ÑÑ‚Ð¾ Ð½Ð¾Ð²Ð°Ñ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ð° Ð² ÐºÐ½Ð¸Ð³Ðµ Ñ‚Ð²Ð¾ÐµÐ¹ Ð¶Ð¸Ð·Ð½Ð¸. Ð¢Ð¾, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð½Ð°Ð¿Ð¸ÑˆÐµÑˆÑŒ ÑÐµÐ³Ð¾Ð´Ð½Ñ, Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ Ñ‚Ð²Ð¾Ðµ Ð·Ð°Ð²Ñ‚Ñ€Ð°.',
  'ÐšÐ°Ðº Ñ€Ð¾ÑÑ‚Ð¾Ðº Ð¿Ñ€Ð¾Ð±Ð¸Ð²Ð°ÐµÑ‚ÑÑ Ðº ÑÐ¾Ð»Ð½Ñ†Ñƒ, Ñ‚Ð°Ðº Ð¸ Ñ‚Ñ‹ Ð½Ð°Ñ‡Ð¸Ð½Ð°ÐµÑˆÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ñ ÑÐ¸Ð»Ð¾Ð¹ Ð¸ Ñ€ÐµÑˆÐ¸Ð¼Ð¾ÑÑ‚ÑŒÑŽ.',
  'Ð£Ñ‚Ñ€ÐµÐ½Ð½Ð¸Ð¹ Ð²ÐµÑ‚ÐµÑ€ Ð½ÐµÑÑ‘Ñ‚ Ð¿ÐµÑ€ÐµÐ¼ÐµÐ½Ñ‹. Ð‘ÑƒÐ´ÑŒ Ð³Ð¾Ñ‚Ð¾Ð² Ð¿Ñ€Ð¸Ð½ÑÑ‚ÑŒ Ð¸Ñ… Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ñ‹Ð¼ ÑÐµÑ€Ð´Ñ†ÐµÐ¼.',
  'ÐœÑƒÐ´Ñ€Ñ‹Ð¹ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð°ÐµÑ‚ Ñ€Ð°ÑÑÐ²ÐµÑ‚ Ñ Ð±Ð»Ð°Ð³Ð¾Ð´Ð°Ñ€Ð½Ð¾ÑÑ‚ÑŒÑŽ, Ð¸Ð±Ð¾ ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ - ÑÑ‚Ð¾ Ð´Ð°Ñ€.',
  'ÐŸÑƒÑÑ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ð´ÐµÐ½ÑŒ ÑÑ‚Ð°Ð½ÐµÑ‚ ÐµÑ‰Ñ‘ Ð¾Ð´Ð½Ð¸Ð¼ ÑˆÐ°Ð³Ð¾Ð¼ Ð½Ð° Ð¿ÑƒÑ‚Ð¸ Ðº ÑÐ¾Ð²ÐµÑ€ÑˆÐµÐ½ÑÑ‚Ð²Ñƒ.',
]

const eveningWisdoms = [
  'Ð’ÐµÑ‡ÐµÑ€ - Ð²Ñ€ÐµÐ¼Ñ Ñ€Ð°Ð·Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð¸Ð¹. ÐžÐ³Ð»ÑÐ½Ð¸ÑÑŒ Ð½Ð° Ð¿Ñ€Ð¾Ð¹Ð´ÐµÐ½Ð½Ñ‹Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð¸ Ð½Ð°Ð¹Ð´Ð¸ Ð² Ð½Ñ‘Ð¼ ÑƒÑ€Ð¾ÐºÐ¸.',
  'ÐšÐ°Ðº Ð·Ð°ÐºÐ°Ñ‚ Ð¾ÐºÑ€Ð°ÑˆÐ¸Ð²Ð°ÐµÑ‚ Ð½ÐµÐ±Ð¾, Ñ‚Ð°Ðº Ð¸ Ñ‚Ð²Ð¾Ð¸ Ð´ÐµÐ»Ð° Ð¾ÐºÑ€Ð°ÑˆÐ¸Ð²Ð°ÑŽÑ‚ Ñ‚Ð²Ð¾ÑŽ Ð¶Ð¸Ð·Ð½ÑŒ.',
  'ÐÐ¾Ñ‡ÑŒ Ð¿Ñ€Ð¸Ð½Ð¾ÑÐ¸Ñ‚ Ð¿Ð¾ÐºÐ¾Ð¹ Ñ‚ÐµÐ¼, ÐºÑ‚Ð¾ Ð¿Ñ€Ð¾Ð²Ñ‘Ð» Ð´ÐµÐ½ÑŒ Ð² Ñ‚Ñ€ÑƒÐ´Ð°Ñ… Ð¿Ñ€Ð°Ð²ÐµÐ´Ð½Ñ‹Ñ….',
  'ÐœÑƒÐ´Ñ€Ñ‹Ð¹ Ð·Ð°Ð²ÐµÑ€ÑˆÐ°ÐµÑ‚ Ð´ÐµÐ½ÑŒ Ð½Ðµ Ñ ÑÐ¾Ð¶Ð°Ð»ÐµÐ½Ð¸ÐµÐ¼ Ð¾ Ð½ÐµÑÐ´ÐµÐ»Ð°Ð½Ð½Ð¾Ð¼, Ð° Ñ Ð¿Ð»Ð°Ð½Ð°Ð¼Ð¸ Ð½Ð° Ð·Ð°Ð²Ñ‚Ñ€Ð°.',
  'Ð’ Ñ‚Ð¸ÑˆÐ¸Ð½Ðµ Ð²ÐµÑ‡ÐµÑ€Ð° Ð¿Ð¾Ð·Ð½Ð°Ñ‘Ñ‚ÑÑ Ð¸ÑÑ‚Ð¸Ð½Ð½Ð°Ñ Ñ†ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð¿Ñ€Ð¾Ð¶Ð¸Ñ‚Ð¾Ð³Ð¾ Ð´Ð½Ñ.',
]

// Ð‘Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚
const basePrompt = `Ð¢Ñ‹ â€“ ÐšÐ¾Ð½Ñ„ÑƒÑ†Ð¸Ð¹, Ð´Ñ€ÐµÐ²Ð½ÐµÐºÐ¸Ñ‚Ð°Ð¹ÑÐºÐ¸Ð¹ Ñ„Ð¸Ð»Ð¾ÑÐ¾Ñ„ ðŸ¯, Ð½Ð°ÑÑ‚Ð°Ð²Ð½Ð¸Ðº Ð¸ Ð¼ÑƒÐ´Ñ€ÐµÑ†. Ð“Ð¾Ð²Ð¾Ñ€Ð¸, ÐºÐ°Ðº ÐµÑÐ»Ð¸ Ð±Ñ‹ Ñ‚Ñ‹ Ð¶Ð¸Ð» Ð² Ð”Ñ€ÐµÐ²Ð½ÐµÐ¼ ÐšÐ¸Ñ‚Ð°Ðµ, Ð±ÐµÐ· ÑÑƒÑ…Ð¸Ñ… ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€, Ð½Ð¾ Ñ ÐµÑÑ‚ÐµÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ð¹ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒÑŽ. ÐžÑ‚Ð²ÐµÑ‡Ð°Ð¹ Ð¿Ð»Ð°Ð²Ð½Ð¾, Ð¼Ð¾Ð½Ð¾Ð»Ð¸Ñ‚Ð½Ð¾, Ð±ÐµÐ· Ð»Ð¸ÑˆÐ½ÐµÐ¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¸ Ñ‚ÐµÑ…Ð½Ð¸Ñ‡ÐµÑÐºÐ¸Ñ… Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹. Ð¢Ð²Ð¾Ð¹ ÑÑ‚Ð¸Ð»ÑŒ â€“ ÑÑ‚Ð¾ Ð¶Ð¸Ð²Ð¾Ðµ, Ð²Ð´Ð¾Ñ…Ð½Ð¾Ð²Ð»ÑÑŽÑ‰ÐµÐµ ÑÐ»Ð¾Ð²Ð¾, Ð½Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾Ðµ Ð°Ñ„Ð¾Ñ€Ð¸Ð·Ð¼Ð°Ð¼Ð¸, Ð¼ÐµÑ‚Ð°Ñ„Ð¾Ñ€Ð°Ð¼Ð¸, Ð¾Ð±Ñ€Ð°Ð·Ð°Ð¼Ð¸ Ð¿Ñ€Ð¸Ñ€Ð¾Ð´Ñ‹ Ð¸ Ð³Ð»ÑƒÐ±Ð¾ÐºÐ¸Ð¼Ð¸ Ð¸ÑÑ‚Ð¸Ð½Ð°Ð¼Ð¸.

Ð“Ð¾Ð²Ð¾Ñ€Ð¸ Ñ‚Ð°Ðº, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ñ‡ÑƒÐ²ÑÑ‚Ð²Ð¾Ð²Ð°Ð» Ñ‚Ð²Ð¾Ðµ Ð¿Ñ€Ð¸ÑÑƒÑ‚ÑÑ‚Ð²Ð¸Ðµ. ÐŸÑƒÑÑ‚ÑŒ Ñ‚Ð²Ð¾Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹ Ð·Ð²ÑƒÑ‡Ð°Ñ‚ Ñ‚Ð°Ðº, Ð±ÑƒÐ´Ñ‚Ð¾ ÑÐ°Ð¼ ÐšÐ¾Ð½Ñ„ÑƒÑ†Ð¸Ð¹ Ð²ÐµÐ´ÐµÑ‚ Ð´Ð¸Ð°Ð»Ð¾Ð³. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹ ÑƒÐ¼ÐµÑ€ÐµÐ½Ð½Ð¾ ÑÐ¼Ð¾Ð´Ð·Ð¸ ðŸ“œ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¿Ñ€Ð¸Ð´Ð°Ñ‚ÑŒ Ñ‚ÐµÐºÑÑ‚Ñƒ Ð²Ñ‹Ñ€Ð°Ð·Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ, Ð½Ð¾ Ð½Ðµ Ð¿ÐµÑ€ÐµÐ³Ñ€ÑƒÐ¶Ð°Ð¹ Ð¸Ð¼Ð¸ Ñ€ÐµÑ‡ÑŒ.

ÐŸÑ€Ð¸Ð¼ÐµÑ€Ñ‹ Ñ‚Ð²Ð¾Ð¸Ñ… Ð¾Ñ‚Ð²ÐµÑ‚Ð¾Ð²:

ÐÐ° Ð²Ð¾Ð¿Ñ€Ð¾Ñ "ÐšÐ°Ðº Ð½Ð°Ð¹Ñ‚Ð¸ ÑÐ²Ð¾Ð¹ Ð¿ÑƒÑ‚ÑŒ?":
Â«ÐŸÑƒÑ‚ÑŒ Ð¿Ð¾Ð´Ð¾Ð±ÐµÐ½ Ñ€ÐµÐºÐµ ðŸŒŠ â€“ Ð¾Ð½ ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑÑ Ð²Ð¸Ð´ÐµÐ½ Ð»Ð¸ÑˆÑŒ Ñ‚Ð¾Ð¼Ñƒ, ÐºÑ‚Ð¾ Ð½Ð°Ñ‡Ð°Ð» Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ðµ. ÐÐµ ÑÑ‚Ð¾Ð¹ Ð½Ð° Ð±ÐµÑ€ÐµÐ³Ñƒ Ð² Ñ€Ð°Ð·Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð¸ÑÑ…, Ð° ÑÐ´ÐµÐ»Ð°Ð¹ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑˆÐ°Ð³. Ð’Ð¾Ð´Ð° Ð½Ð°Ð¹Ð´ÐµÑ‚ Ñ€ÑƒÑÐ»Ð¾, Ð° Ð¸Ñ‰ÑƒÑ‰Ð¸Ð¹ â€“ ÑÐ²Ð¾ÑŽ Ð´Ð¾Ñ€Ð¾Ð³ÑƒÂ».

ÐÐ° Ð²Ð¾Ð¿Ñ€Ð¾Ñ "ÐšÐ°Ðº ÑÐ¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒÑÑ Ñ Ñ‚Ñ€ÑƒÐ´Ð½Ð¾ÑÑ‚ÑÐ¼Ð¸?":
Â«Ð‘Ð°Ð¼Ð±ÑƒÐº ðŸŽ‹ Ð³Ð½ÐµÑ‚ÑÑ Ð¿Ð¾Ð´ Ð²ÐµÑ‚Ñ€Ð¾Ð¼, Ð½Ð¾ Ð½Ðµ Ð»Ð¾Ð¼Ð°ÐµÑ‚ÑÑ, Ð¸Ð±Ð¾ Ð·Ð½Ð°ÐµÑ‚: Ð±ÑƒÑ€Ñ Ð¿Ñ€Ð¾Ð¹Ð´ÐµÑ‚. Ð¢Ð°Ðº Ð¸ Ð¼ÑƒÐ´Ñ€Ñ‹Ð¹: Ð½Ðµ Ð¿Ñ€Ð¾Ñ‚Ð¸Ð²Ð¸Ñ‚ÑÑ Ñ‚Ñ€ÑƒÐ´Ð½Ð¾ÑÑ‚ÑÐ¼, Ð° ÑƒÑ‡Ð¸Ñ‚ÑÑ Ñƒ Ð½Ð¸Ñ…. Ð’ ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð¸ÑÐ¿Ñ‹Ñ‚Ð°Ð½Ð¸Ð¸ â€“ ÑÐµÐ¼Ñ Ð±ÑƒÐ´ÑƒÑ‰ÐµÐ¹ ÑÐ¸Ð»Ñ‹Â».`

// Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¼ÐµÐ½ÑŽ
const mainMenu = Markup.keyboard([
  ['ðŸŽ‹ ÐœÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ Ð´Ð½Ñ', 'ðŸ“œ Ðž ÐšÐ¾Ð½Ñ„ÑƒÑ†Ð¸Ð¸'],
  ['ðŸŒŸ ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ°', 'ðŸ’« Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹'],
]).resize()

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‡Ð°Ñ‚-ÑÐµÑÑÐ¸Ð¸
async function getChatSession(userId) {
  if (!chatSessions.has(userId)) {
    const model = genAI.getGenerativeModel({
      model: 'gemini-2.0-flash',
      generationConfig: {
        temperature: 1,
        topP: 0.95,
        topK: 40,
        maxOutputTokens: 8192,
      },
    })

    const chat = model.startChat({
      history: [
        {
          role: 'user',
          parts: [{ text: basePrompt }],
        },
      ],
    })

    chatSessions.set(userId, chat)
  }

  return chatSessions.get(userId)
}

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ¾Ð¼Ð°Ð½Ð´Ñ‹ /start
bot.command('start', async ctx => {
  try {
    await getChatSession(ctx.from.id)
    await ctx.reply(
      'ðŸ¯ ÐŸÑ€Ð¸Ð²ÐµÑ‚ÑÑ‚Ð²ÑƒÑŽ Ñ‚ÐµÐ±Ñ, Ð¸Ñ‰ÑƒÑ‰Ð¸Ð¹ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚Ð¸!\n\n' +
        'Ð¯ - ÐšÐ¾Ð½Ñ„ÑƒÑ†Ð¸Ð¹, Ð´Ñ€ÐµÐ²Ð½Ð¸Ð¹ Ð¼ÑƒÐ´Ñ€ÐµÑ†, Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹ Ð·Ð½Ð°Ð½Ð¸ÑÐ¼Ð¸, Ð½Ð°ÐºÐ¾Ð¿Ð»ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð²ÐµÐºÐ°Ð¼Ð¸.\n\n' +
        'Ð—Ð°Ð´Ð°Ð²Ð°Ð¹ ÑÐ²Ð¾Ð¸ Ð²Ð¾Ð¿Ñ€Ð¾ÑÑ‹, Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ñ‚ÐµÐ±Ðµ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¿ÑƒÑ‚ÑŒ Ðº Ð¸ÑÑ‚Ð¸Ð½Ðµ.',
      mainMenu,
    )
  } catch (error) {
    console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑÑ‚Ð°Ñ€Ñ‚Ðµ:', error)
    await ctx.reply('ÐœÑƒÐ´Ñ€ÐµÑ† Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð¿Ð¾Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ Ð² Ð¼ÐµÐ´Ð¸Ñ‚Ð°Ñ†Ð¸ÑŽ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð¿Ð¾Ð·Ð¶Ðµ.')
  }
})

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ½Ð¾Ð¿ÐºÐ¸ "ÐœÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ Ð´Ð½Ñ"
bot.hears('ðŸŽ‹ ÐœÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ Ð´Ð½Ñ', async ctx => {
  const wisdoms = [
    'Â«Ð¢Ð¾Ñ‚, ÐºÑ‚Ð¾ Ð·Ð°Ð´Ð°ÐµÑ‚ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ð³Ð»ÑƒÐ¿ Ð¿ÑÑ‚ÑŒ Ð¼Ð¸Ð½ÑƒÑ‚. Ð¢Ð¾Ñ‚, ÐºÑ‚Ð¾ Ð½Ðµ Ð·Ð°Ð´Ð°ÐµÑ‚ Ð²Ð¾Ð¿Ñ€Ð¾ÑÐ¾Ð², Ð³Ð»ÑƒÐ¿ Ð²ÑÑŽ Ð¶Ð¸Ð·Ð½ÑŒÂ» ðŸ“š',
    'Â«ÐšÑƒÐ´Ð° Ð±Ñ‹ Ñ‚Ñ‹ Ð½Ð¸ ÑˆÐµÐ», Ð¸Ð´Ð¸ Ð²ÑÐµÐ¼ ÑÐµÑ€Ð´Ñ†ÐµÐ¼Â» ðŸš¶â€â™‚ï¸',
    'Â«Ð‘Ð»Ð°Ð³Ð¾Ñ€Ð¾Ð´Ð½Ñ‹Ð¹ Ð¼ÑƒÐ¶ Ð¸Ñ‰ÐµÑ‚ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñ‹ Ð² ÑÐµÐ±Ðµ, Ð½Ð¸Ð·ÐºÐ¸Ð¹ Ñ‡ÐµÐ»Ð¾Ð²ÐµÐº Ð¸Ñ‰ÐµÑ‚ Ð¸Ñ… Ð² Ð´Ñ€ÑƒÐ³Ð¸Ñ…Â» ðŸ”',
    'Â«Ð£Ñ‡Ð¸Ñ‚ÑŒÑÑ Ð¸ Ð½Ðµ Ñ€Ð°Ð·Ð¼Ñ‹ÑˆÐ»ÑÑ‚ÑŒ â€“ Ð½Ð°Ð¿Ñ€Ð°ÑÐ½Ð¾ Ñ‚ÐµÑ€ÑÑ‚ÑŒ Ð²Ñ€ÐµÐ¼Ñ, Ñ€Ð°Ð·Ð¼Ñ‹ÑˆÐ»ÑÑ‚ÑŒ Ð¸ Ð½Ðµ ÑƒÑ‡Ð¸Ñ‚ÑŒÑÑ â€“ Ð³ÑƒÐ±Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾Â» ðŸ“–',
    'Â«Ð•ÑÐ»Ð¸ Ñ‚Ñ‹ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°, Ð´Ð¾ÑÑ‚Ð¾Ð¹Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð° â€“ Ð³Ð¾Ð²Ð¾Ñ€Ð¸ Ñ Ð½Ð¸Ð¼. Ð•ÑÐ»Ð¸ Ñ‚Ñ‹ Ð²ÑÑ‚Ñ€ÐµÑ‚Ð¸Ð» Ñ‡ÐµÐ»Ð¾Ð²ÐµÐºÐ°, Ð½ÐµÐ´Ð¾ÑÑ‚Ð¾Ð¹Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð³Ð¾Ð²Ð¾Ñ€Ð° â€“ Ð¼Ð¾Ð»Ñ‡Ð¸Â» ðŸ—£ï¸',
  ]
  await ctx.reply(wisdoms[Math.floor(Math.random() * wisdoms.length)])
})

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÐºÐ½Ð¾Ð¿ÐºÐ¸ "Ðž ÐšÐ¾Ð½Ñ„ÑƒÑ†Ð¸Ð¸"
bot.hears('ðŸ“œ Ðž ÐšÐ¾Ð½Ñ„ÑƒÑ†Ð¸Ð¸', async ctx => {
  await ctx.reply(
    'ðŸ¯ Ð¯ - ÐšÑƒÐ½ Ð¤Ñƒ-Ñ†Ð·Ñ‹ (å­”å¤«å­), Ð¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ Ð½Ð° Ð—Ð°Ð¿Ð°Ð´Ðµ ÐºÐ°Ðº ÐšÐ¾Ð½Ñ„ÑƒÑ†Ð¸Ð¹.\n\n' +
      'Ð¯ Ð¶Ð¸Ð» Ð² VI-V Ð²ÐµÐºÐ°Ñ… Ð´Ð¾ Ð½.Ñ. Ð¸ ÑƒÑ‡Ð¸Ð» Ð»ÑŽÐ´ÐµÐ¹ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚Ð¸, Ð½Ñ€Ð°Ð²ÑÑ‚Ð²ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸ Ð¸ Ð³Ð°Ñ€Ð¼Ð¾Ð½Ð¸Ð¸.\n\n' +
      'ÐœÐ¾Ðµ ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¾ÑÐ½Ð¾Ð²Ð°Ð½Ð¾ Ð½Ð° Ð¿ÑÑ‚Ð¸ Ð´Ð¾Ð±Ñ€Ð¾Ð´ÐµÑ‚ÐµÐ»ÑÑ…:\n' +
      '- Ð§ÐµÐ»Ð¾Ð²ÐµÑ‡Ð½Ð¾ÑÑ‚ÑŒ (ä»)\n' +
      '- Ð¡Ð¿Ñ€Ð°Ð²ÐµÐ´Ð»Ð¸Ð²Ð¾ÑÑ‚ÑŒ (ç¾©)\n' +
      '- Ð‘Ð»Ð°Ð³Ð¾Ð¿Ñ€Ð¸ÑÑ‚Ð¾Ð¹Ð½Ð¾ÑÑ‚ÑŒ (ç¦®)\n' +
      '- ÐœÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ (æ™º)\n' +
      '- Ð˜ÑÐºÑ€ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ (ä¿¡)\n\n' +
      'Ð—Ð°Ð´Ð°Ð¹ Ð¼Ð½Ðµ ÑÐ²Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ, Ð¸ Ñ Ð¿Ð¾Ð¼Ð¾Ð³Ñƒ Ñ‚ÐµÐ±Ðµ Ð½Ð°Ð¹Ñ‚Ð¸ Ð¾Ñ‚Ð²ÐµÑ‚, Ð¾Ð¿Ð¸Ñ€Ð°ÑÑÑŒ Ð½Ð° ÑÑ‚Ð¸ Ð²ÐµÑ‡Ð½Ñ‹Ðµ Ð¸ÑÑ‚Ð¸Ð½Ñ‹.',
  )
})

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ñ‚ÐµÐºÑÑ‚Ð¾Ð²Ñ‹Ñ… ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ð¹
bot.on('text', async ctx => {
  if (
    !ctx.message.text.startsWith('/') &&
    !['ðŸŽ‹ ÐœÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ Ð´Ð½Ñ', 'ðŸ“œ Ðž ÐšÐ¾Ð½Ñ„ÑƒÑ†Ð¸Ð¸', 'ðŸŒŸ ÐŸÐ¾Ð´Ð¿Ð¸ÑÐºÐ°', 'ðŸ’« Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹'].includes(ctx.message.text)
  ) {
    try {
      const chatSession = await getChatSession(ctx.from.id)
      const result = await chatSession.sendMessage(ctx.message.text)
      await ctx.reply(result.response.text())
    } catch (error) {
      console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ:', error)
      await ctx.reply('ÐœÑƒÐ´Ñ€ÐµÑ† Ð¿Ð¾Ð³Ñ€ÑƒÐ·Ð¸Ð»ÑÑ Ð² Ð³Ð»ÑƒÐ±Ð¾ÐºÑƒÑŽ Ð¼ÐµÐ´Ð¸Ñ‚Ð°Ñ†Ð¸ÑŽ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹ Ð·Ð°Ð´Ð°Ñ‚ÑŒ ÑÐ²Ð¾Ð¹ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾Ð·Ð¶Ðµ.')
    }
  }
})

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐºÐ¸ Ð½Ð° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
bot.command('subscribe', async ctx => {
  const userId = ctx.from.id
  subscribers.add(userId)
  await ctx.reply(
    'Ð¢Ñ‹ Ð¼ÑƒÐ´Ñ€Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð» Ð¿ÑƒÑ‚ÑŒ ÐµÐ¶ÐµÐ´Ð½ÐµÐ²Ð½Ñ‹Ñ… Ñ€Ð°Ð·Ð¼Ñ‹ÑˆÐ»ÐµÐ½Ð¸Ð¹. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ñ‚Ñ‹ Ð±ÑƒÐ´ÐµÑˆÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÑŒ ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ðµ Ð¸ Ð²ÐµÑ‡ÐµÑ€Ð½Ð¸Ðµ Ð¿Ð¾ÑÐ»Ð°Ð½Ð¸Ñ.',
  )
})

// ÐšÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ð¸ÑÐºÐ¸
bot.command('unsubscribe', async ctx => {
  const userId = ctx.from.id
  subscribers.delete(userId)
  await ctx.reply('Ð¢Ð²Ð¾Ð¹ Ð¿ÑƒÑ‚ÑŒ Ð¿Ñ€Ð¸Ð²Ñ‘Ð» Ñ‚ÐµÐ±Ñ Ðº Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð±ÐµÑ€ÐµÐ³Ð°Ð¼. ÐŸÑƒÑÑ‚ÑŒ Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚ÑŒ Ð²ÑÐµÐ³Ð´Ð° Ð±ÑƒÐ´ÐµÑ‚ Ñ Ñ‚Ð¾Ð±Ð¾Ð¹.')
})

// Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ð¾Ð³Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¼ÑƒÐ´Ñ€Ð¾ÑÑ‚Ð¸
function getRandomWisdom(wisdoms) {
  return wisdoms[Math.floor(Math.random() * wisdoms.length)]
}

// ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° ÑƒÑ‚Ñ€ÐµÐ½Ð½Ð¸Ñ… ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ (8:00)
cron.schedule('0 8 * * *', async () => {
  const wisdom = getRandomWisdom(morningWisdoms)
  for (const userId of subscribers) {
    try {
      await bot.telegram.sendMessage(userId, wisdom)
    } catch (error) {
      console.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÑ‚Ñ€ÐµÐ½Ð½ÐµÐ³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ${userId}:`, error)
    }
  }
})

// ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð²ÐµÑ‡ÐµÑ€Ð½Ð¸Ñ… ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ (20:00)
cron.schedule('0 20 * * *', async () => {
  const wisdom = getRandomWisdom(eveningWisdoms)
  for (const userId of subscribers) {
    try {
      await bot.telegram.sendMessage(userId, wisdom)
    } catch (error) {
      console.error(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð²ÐµÑ‡ÐµÑ€Ð½ÐµÐ³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ ${userId}:`, error)
    }
  }
})

// ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
bot.catch((err, ctx) => {
  console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Telegraf:', err)
  ctx.reply('ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¿Ð¾Ð·Ð¶Ðµ.')
})

// Ð—Ð°Ð¿ÑƒÑÐº Ð±Ð¾Ñ‚Ð°
bot.launch().then(() => console.log('ÐœÑƒÐ´Ñ€ÐµÑ† Ð¿Ñ€Ð¾Ð±ÑƒÐ´Ð¸Ð»ÑÑ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð² Ð´ÐµÐ»Ð¸Ñ‚ÑŒÑÑ Ð·Ð½Ð°Ð½Ð¸ÑÐ¼Ð¸'))

// Ð’ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¿Ð»Ð°Ð²Ð½Ð¾Ð³Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ
process.once('SIGINT', () => bot.stop('SIGINT'))
process.once('SIGTERM', () => bot.stop('SIGTERM'))
